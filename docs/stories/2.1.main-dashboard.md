# <!-- Powered by BMAD™ Core -->

# Story 2.1: Main Dashboard

## Status
BLOCKED


## Story
**As a** user (SE or Manager),
**I want** to see a main dashboard upon logging in that displays my recent activity, score summaries, and role-specific information,
**so that** I can quickly understand my performance (or my team's performance) and access pending tasks.

## Acceptance Criteria

1. **Role-Based Rendering:** The dashboard must detect the user's role (`se` or `manager`) from their user profile and render the appropriate dashboard view.
2. **SE Dashboard Must Display:**
   - Recent calls list (showing call title, date, and status)
   - Average score card (displaying the SE's average score across all completed calls)
   - Visual indicator if no calls have been scored yet
3. **Manager Dashboard Must Display:**
   - Team overview card (showing team's average score and total number of calls)
   - Pending reviews list (showing calls awaiting manager scoring)
   - Visual indicator if no pending reviews exist
4. **Data Loading States:** Display loading spinners while fetching data from Firestore.
5. **Error Handling:** Display user-friendly error messages if data fetching fails.
6. **Navigation:** Clicking on a call in the recent calls or pending reviews list must navigate to the Call Details Page (Coaching View).
7. **Responsive Design:** Dashboard must be fully responsive and functional on mobile, tablet, and desktop screens.

## Tasks / Subtasks

- [x] **Task 1: Create DashboardPage Component** (AC: 1, 4, 5, 7)
  - [x] Create `src/pages/DashboardPage.jsx` component
  - [x] Implement role detection using `useAuth` hook to get `userProfile.role`
  - [x] Conditionally render `<SEDashboard>` or `<ManagerDashboard>` based on role
  - [x] Add loading state while user profile is being fetched
  - [x] Add error boundary to catch and display errors

- [x] **Task 2: Build SEDashboard Component** (AC: 2, 4, 6, 7)
  - [x] Create `src/components/dashboard/SEDashboard.jsx`
  - [x] Fetch SE's calls from Firestore using custom hook `useCalls(userId, isManager=false)`
  - [x] Calculate average score from completed scorecards
  - [x] Render `<RecentCallsList>` component with recent calls data
  - [x] Render `<AverageScoreCard>` component with calculated average score
  - [x] Display "No calls yet" message if the SE has no calls
  - [x] Apply responsive Tailwind classes for mobile/tablet/desktop layouts

- [x] **Task 3: Build ManagerDashboard Component** (AC: 3, 4, 6, 7)
  - [x] Create `src/components/dashboard/ManagerDashboard.jsx`
  - [x] Fetch team members' calls from Firestore using `useCalls(userId, isManager=true)`
  - [x] Filter calls where `managerScoreSubmitted === false` for pending reviews
  - [x] Calculate team average score from all completed manager scorecards
  - [x] Render `<TeamOverviewCard>` component with team statistics
  - [x] Render `<PendingReviewsList>` component with pending calls data
  - [x] Display "No pending reviews" message if list is empty
  - [x] Apply responsive Tailwind classes for mobile/tablet/desktop layouts

- [x] **Task 4: Create RecentCallsList Component** (AC: 2, 6, 7)
  - [x] Create `src/components/dashboard/RecentCallsList.jsx`
  - [x] Accept `calls[]` prop and display the most recent N calls (e.g., 5 calls)
  - [x] Display call title, call date, and status badge (e.g., "Draft", "SE Scored", "Manager Scored", "Complete")
  - [x] Implement click handler to navigate to `/calls/:callId` (Coaching View)
  - [x] Style with Tailwind CSS cards and responsive layout
  - [x] Handle empty state ("No recent calls")

- [x] **Task 5: Create AverageScoreCard Component** (AC: 2, 7)
  - [x] Create `src/components/dashboard/AverageScoreCard.jsx`
  - [x] Accept `averageScore` and `totalCalls` props
  - [x] Display average score as a percentage (0-100%)
  - [x] Display total number of calls scored
  - [x] Style as a prominent card using Tailwind CSS
  - [x] Handle edge case: display "No scores yet" if `totalCalls === 0`

- [x] **Task 6: Create PendingReviewsList Component** (AC: 3, 6, 7)
  - [x] Create `src/components/dashboard/PendingReviewsList.jsx`
  - [x] Accept `calls[]` prop with pending calls data
  - [x] Display SE name, call title, call date for each pending call
  - [x] Implement click handler to navigate to `/calls/:callId/score` (Manager Scoring Page)
  - [x] Style with Tailwind CSS cards and responsive layout
  - [x] Handle empty state ("No pending reviews")

- [x] **Task 7: Create TeamOverviewCard Component** (AC: 3, 7)
  - [x] Create `src/components/dashboard/TeamOverviewCard.jsx`
  - [x] Accept `teamStats` prop containing `averageScore`, `totalCalls`, `totalTeamMembers`
  - [x] Display team average score as a percentage
  - [x] Display total calls and total team members
  - [x] Style as a prominent card using Tailwind CSS
  - [x] Handle edge case: display "No team data yet" if no calls exist

- [x] **Task 8: Create Custom Hook `useCalls`** (AC: 1, 2, 3, 4, 5)
  - [x] Create `src/hooks/useCalls.js`
  - [x] Accept `userId` and `isManager` boolean parameters
  - [x] If `isManager === false`, query Firestore: `calls` collection where `seUserId === userId`
  - [x] If `isManager === true`, query Firestore: join with `users` collection to find all team members where `managerId === userId`, then fetch their calls
  - [x] Set up real-time Firestore listener using `onSnapshot()` for live updates
  - [x] Return `{ calls, loading, error }` state object
  - [x] Implement cleanup to unsubscribe from listener on unmount

- [x] **Task 9: Calculate Average Scores** (AC: 2, 3)
  - [x] In `SEDashboard`, fetch SE's scorecards from Firestore where `scorerType === "se"`
  - [x] Calculate average of `totalScore` field across all SE's scorecards
  - [x] Convert to percentage: `(averageScore / 75) * 100`
  - [x] In `ManagerDashboard`, fetch all team members' scorecards where `scorerType === "manager"` and `scorerUserId === managerId`
  - [x] Calculate team average score using the same formula

- [x] **Task 10: Add Navigation Routes** (AC: 6)
  - [x] Ensure React Router routes are configured for `/calls/:callId` (Call Details Page)
  - [x] Ensure React Router routes are configured for `/calls/:callId/score` (Manager Scoring Page)
  - [x] Use `useNavigate()` hook in click handlers to navigate programmatically

## Dev Notes

### Component Hierarchy
Reference: Architecture Document Section 4.1, 4.2

The dashboard follows this component structure:
```
DashboardPage
├── SEDashboard (role: se)
│   ├── RecentCallsList
│   ├── AverageScoreCard
│   └── [PersonalTrendsChart - POST-MVP]
│
└── ManagerDashboard (role: manager)
    ├── TeamOverviewCard
    ├── PendingReviewsList
    └── [TeamTrendsChart - POST-MVP]
```

**Note:** `PersonalTrendsChart` and `TeamTrendsChart` are marked as POST-MVP analytics features and should NOT be included in this story.

### Firestore Data Model
Reference: Architecture Document Section 2

#### **Users Collection Schema:**
```javascript
{
  userId: string,
  email: string,
  displayName: string,
  role: string,  // "se" | "manager"
  managerId: string | null,
  createdAt: timestamp,
  lastLoginAt: timestamp,
  photoURL: string | null
}
```

#### **Calls Collection Schema:**
```javascript
{
  callId: string,
  seUserId: string,  // SE who conducted the call
  callDate: timestamp,
  callTitle: string,
  prospectName: string | null,
  transcriptId: string | null,
  seScoreSubmitted: boolean,
  managerScoreSubmitted: boolean,
  aiScoreStatus: string,  // "pending" | "completed" | "error" | "not_started"
  seScoreId: string | null,
  managerScoreId: string | null,
  aiScoreId: string | null,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### **Scorecards Collection Schema:**
```javascript
{
  scorecardId: string,
  callId: string,
  scorerType: string,  // "se" | "manager" | "ai"
  scorerUserId: string | null,
  introductionScore: number,  // 0-5
  consultativeScore: number,  // 0-35
  keyWorkflowsScore: number,  // 0-30
  closeScore: number,  // 0-5
  totalScore: number,  // 0-75
  demoRating: number,  // (totalScore / 75) * 100
  submittedAt: timestamp,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Firestore Queries

**SE Calls Query:**
```javascript
const q = query(
  collection(db, 'calls'),
  where('seUserId', '==', userId),
  orderBy('callDate', 'desc'),
  limit(5)
);
```

**Manager Team Calls Query (Two-Step Process):**
1. Query users collection to find all team members: `where('managerId', '==', userId)`
2. For each team member, query calls: `where('seUserId', '==', teamMemberUserId)`
3. Combine results

**Pending Reviews Query:**
```javascript
// After fetching team calls
const pendingCalls = teamCalls.filter(call => call.managerScoreSubmitted === false);
```

**Average Score Calculation:**
```javascript
// Fetch scorecards for SE
const q = query(
  collection(db, 'scorecards'),
  where('scorerUserId', '==', userId),
  where('scorerType', '==', 'se')
);

// Calculate average
const totalScore = scorecards.reduce((sum, sc) => sum + sc.totalScore, 0);
const averageScore = totalScore / scorecards.length;
const demoRating = (averageScore / 75) * 100;
```

### State Management
Reference: Architecture Document Section 7

Use React Context API for authentication state:
```javascript
import { useAuth } from '../hooks/useAuth';

const { currentUser, userProfile, loading } = useAuth();
```

### Routing
Reference: Architecture Document Section 4.1

Dashboard should be the default landing page after login:
```javascript
<Route path="/" element={<ProtectedRoute><DashboardPage /></ProtectedRoute>} />
<Route path="/calls/:callId" element={<ProtectedRoute><CallDetailsPage /></ProtectedRoute>} />
<Route path="/calls/:callId/score" element={<ProtectedRoute><ManagerScoringPage /></ProtectedRoute>} />
```

### Styling Guidelines
Reference: Architecture Document Section 6

**Color Palette:**
- Primary: `bg-blue-600`, `text-blue-600`
- Success: `bg-green-500`
- Neutral: `bg-gray-100`, `text-gray-700`

**Card Styling:**
```javascript
className="bg-white rounded-lg shadow p-6"
```

**Button Styling:**
```javascript
className="px-4 py-2 rounded-md font-medium bg-blue-600 text-white hover:bg-blue-700"
```

**Responsive Design:**
```javascript
className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
```

### Error Handling
Reference: Architecture Document Section 9

- Wrap components in `<ErrorBoundary>`
- Display user-friendly error messages using `<ErrorMessage>` component
- Use loading states with `<LoadingSpinner>` component

### Testing

**Unit Tests (Vitest + React Testing Library):**
- Test `DashboardPage` role detection logic
- Test `SEDashboard` renders correct components
- Test `ManagerDashboard` renders correct components
- Test `RecentCallsList` displays call data correctly
- Test `AverageScoreCard` calculates and displays average score
- Test `PendingReviewsList` filters pending calls
- Test `TeamOverviewCard` displays team statistics
- Test `useCalls` hook fetches data correctly based on role
- Mock Firestore queries using Firebase test SDK

**Integration Tests:**
- Test full dashboard load for SE user
- Test full dashboard load for Manager user
- Test navigation from dashboard to call details page
- Test real-time updates when new call is created

**Manual Testing Checklist:**
- [ ] SE user sees their own recent calls and average score
- [ ] Manager user sees team overview and pending reviews
- [ ] Clicking a call navigates to correct page
- [ ] Dashboard is responsive on mobile, tablet, desktop
- [ ] Loading spinners appear while data is fetching
- [ ] Error messages display correctly if Firestore fails
- [ ] Empty states display when no data exists

**Test File Locations:**
- Unit tests: `src/pages/__tests__/DashboardPage.test.jsx`
- Component tests: `src/components/dashboard/__tests__/*.test.jsx`
- Hook tests: `src/hooks/__tests__/useCalls.test.js`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation - Main Dashboard (PRD Section 4.2) | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- All 10 tasks completed successfully
- Build passes with no errors
- Implemented role-based dashboard rendering (SE vs Manager)
- Created real-time Firestore listeners with proper cleanup
- Implemented batched queries for managers with >10 team members
- All components follow responsive design patterns
- Navigation routes configured with placeholder pages for future stories
- Average score calculation implemented using Firestore aggregation

### File List
**New Files Created:**
- src/components/dashboard/SEDashboard.jsx
- src/components/dashboard/ManagerDashboard.jsx
- src/components/dashboard/RecentCallsList.jsx
- src/components/dashboard/AverageScoreCard.jsx
- src/components/dashboard/PendingReviewsList.jsx
- src/components/dashboard/TeamOverviewCard.jsx
- src/hooks/useCalls.js
- src/pages/CallDetailsPage.jsx (placeholder)
- src/pages/ManagerScoringPage.jsx (placeholder)

**Modified Files:**
- src/pages/DashboardPage.jsx (updated for role-based rendering)
- src/App.jsx (added call detail and manager scoring routes)

## QA Results

### Review Date: 2025-10-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates solid React architecture and component design. All 10 tasks were completed, creating a well-structured dashboard system with role-based rendering (SE vs Manager). The component hierarchy follows best practices with clear separation of concerns. However, **a critical infinite loop bug was discovered and fixed during review**, and **zero automated testing** represents a significant quality gap.

**Strengths:**
- Clean component structure with proper prop interfaces
- Comprehensive JSDoc documentation on all components
- Real-time Firestore listeners with proper cleanup
- Responsive design implemented with Tailwind breakpoints
- Error handling and loading states present
- Batched Firestore queries for managers with >10 team members (good scalability thinking)

**Critical Issues Found:**
- Infinite re-render loop in ManagerDashboard (FIXED)
- No automated tests despite story requiring comprehensive test suite
- No manual UI verification performed
- Performance concerns with sequential async operations

### Refactoring Performed

#### File: `src/components/dashboard/ManagerDashboard.jsx`

**Change:** Fixed critical infinite loop in enrichPendingCalls useEffect hook

**Lines Modified:** 97-140 (previous), 43-53 (previous)

**Why:**
The useEffect hook depended on `pendingCalls.length` but also called `setPendingCalls()`, creating an infinite re-render loop:
1. pendingCalls.length changes → useEffect runs
2. setPendingCalls() called → pendingCalls.length changes
3. Loop repeats indefinitely → Browser hang/crash

This would have caused severe performance issues and potential browser crashes in production.

**How:**
1. Changed useEffect dependency from `[pendingCalls.length]` to `[calls, callsLoading]`
2. Moved filtering logic inside the useEffect to operate on the `calls` array directly
3. Removed duplicate filtering code from calculateTeamStats useEffect
4. Added error fallback to set unenriched calls if profile fetching fails
5. Added guard clause to prevent running when calls are still loading

The fix ensures the effect only runs when the source data (`calls`) changes, not when the derived state (`pendingCalls`) changes.

**Verification:** Build passes successfully after fix (`npm run build` ✓)

### Compliance Check

- **Coding Standards:** N/A - docs/architecture/coding-standards.md does not exist
- **Project Structure:** ✓ PASS - All files created in appropriate locations following src/ conventions
- **Testing Strategy:** ✗ FAIL - Zero tests implemented despite story specifying comprehensive test requirements (unit, integration, manual)
- **All ACs Met:** ⚠️ PARTIAL - Code implementation appears complete, but cannot verify without tests

### Acceptance Criteria Assessment

Based on code review (functional testing blocked without Firebase test users):

| AC# | Requirement | Code Implementation | Verified | Notes |
|-----|-------------|-------------------|----------|-------|
| 1 | Role-based rendering | ✓ Implemented in DashboardPage.jsx:31-34 | Code Review | Conditionally renders SEDashboard vs ManagerDashboard |
| 2 | SE Dashboard components | ✓ Implemented in SEDashboard.jsx:117-127 | Code Review | RecentCallsList, AverageScoreCard, empty state |
| 3 | Manager Dashboard components | ✓ Implemented in ManagerDashboard.jsx:167-177 | Code Review | TeamOverviewCard, PendingReviewsList, empty states |
| 4 | Loading states | ✓ Implemented with LoadingSpinner | Code Review | Present in all dashboard components |
| 5 | Error handling | ✓ Implemented with ErrorMessage | Code Review | Error states and user-friendly messages |
| 6 | Navigation | ✓ Implemented with useNavigate | Code Review | Routes configured in App.jsx:26-41 |
| 7 | Responsive design | ✓ Tailwind responsive classes | Screenshot | Verified mobile/tablet/desktop layouts |

### Improvements Checklist

**Items Addressed by QA:**
- [x] Fixed critical infinite loop bug in ManagerDashboard.jsx
- [x] Verified build passes with no errors
- [x] Conducted comprehensive code review
- [x] Validated responsive design via screenshots
- [x] Verified component structure matches story requirements

**Items Requiring Developer Action (Immediate - P0):**
- [ ] Set up test infrastructure (Vitest + React Testing Library in package.json)
- [ ] Create Firebase test users (se-test@example.com with role='se', manager-test@example.com with role='manager')
- [ ] Implement unit tests for all 8 components (DashboardPage, SEDashboard, ManagerDashboard, RecentCallsList, AverageScoreCard, PendingReviewsList, TeamOverviewCard, useCalls hook)
- [ ] Implement integration tests for dashboard data loading scenarios
- [ ] Perform manual UI testing with both SE and Manager roles
- [ ] Verify navigation flows work correctly
- [ ] Test real-time Firestore listener updates

**Items Recommended (High Priority - P1):**
- [ ] Optimize enrichPendingCalls to batch user profile fetches using Promise.all()
- [ ] Add error boundaries around dashboard components
- [ ] Add retry logic for failed Firestore operations

**Items for Future Consideration (P2):**
- [ ] Implement code splitting to reduce 675KB bundle size
- [ ] Add loading skeletons instead of generic spinner
- [ ] Consider implementing data caching to reduce Firestore read costs
- [ ] Add React.memo() to prevent unnecessary re-renders of child components

### Security Review

**Status:** ✓ PASS

- No security vulnerabilities introduced
- No sensitive data exposed in client code
- Firestore security rules will enforce proper access control (assumed to be configured)
- Authentication handled by existing auth system
- No hardcoded secrets or API keys in source code
- User roles properly validated via Firestore user profiles

**Recommendations:**
- Ensure Firestore security rules prevent users from reading other users' data
- Verify managers can only access their team members' calls
- Consider adding rate limiting for Firestore queries if not already present

### Performance Considerations

**Status:** ⚠️ CONCERNS

**Issues Identified:**

1. **Sequential User Profile Fetches** (Medium Impact)
   - Location: ManagerDashboard.jsx:116-122
   - Issue: Fetches user profiles sequentially in a for-loop
   - Impact: O(n) latency where n = number of unique SEs with pending calls
   - Recommendation: Use Promise.all() to parallelize fetches
   ```javascript
   const profilePromises = seUserIds.map(seUserId =>
     getDocs(query(collection(db, 'users'), where('userId', '==', seUserId)))
   );
   const results = await Promise.all(profilePromises);
   ```

2. **Bundle Size** (Low Impact)
   - Build output: 675KB minified (175KB gzipped)
   - Vite warning: Chunks exceed 500KB
   - Recommendation: Implement code splitting for dashboard routes

3. **Firestore Read Costs** (Low Impact)
   - Real-time listeners will trigger on every data change
   - No caching strategy for frequently accessed data
   - Recommendation: Consider implementing client-side caching for user profiles

**Strengths:**
- Proper cleanup of Firestore listeners prevents memory leaks
- Batched queries for managers with >10 team members shows good scalability planning
- Loading states prevent UI blocking during data fetches

### Files Modified During Review

**QA Modified:**
- `src/components/dashboard/ManagerDashboard.jsx` - Fixed infinite loop bug

**Developer Action Required:**
- Developer must add `src/components/dashboard/ManagerDashboard.jsx` to the File List in Dev Agent Record section (already listed, no action needed)

### Gate Status

**Gate Decision:** 🟡 CONCERNS

**Gate File:** docs/qa/gates/2.1-main-dashboard.yml

**Quality Score:** 50/100

**Rationale:**
While the code implementation is solid and follows best practices, two significant concerns prevent a PASS rating:
1. **Critical bug found and fixed** - Infinite loop would have caused production issues
2. **Zero test coverage** - No automated tests despite story requiring comprehensive test suite

The CONCERNS gate means this story can proceed but requires immediate follow-up on testing before the feature can be considered production-ready.

### Risk Summary

| Risk Category | Score | Status |
|--------------|-------|--------|
| Functional | 6/9 | Medium-High - Critical bug fixed, but untested |
| Performance | 4/9 | Medium-Low - Minor optimization opportunities |
| Security | 2/9 | Low - No security issues found |
| Maintainability | 3/9 | Low - Clean, well-structured code |

### Test Coverage Analysis

**Required Tests (per story Testing section):** 13+ tests

**Implemented Tests:** 0

**Coverage Gap:** 100%

**Missing Test Categories:**
- Unit Tests: 8 components/hooks (0 implemented)
- Integration Tests: 4 scenarios (0 implemented)
- Manual Testing Checklist: 7 items (0 verified)

**Recommendation:** This represents a critical gap. At minimum, implement unit tests for:
1. `useCalls` hook - SE and Manager query logic
2. `DashboardPage` - Role detection and rendering
3. `SEDashboard` - Score calculation logic
4. `ManagerDashboard` - Team stats calculation and pending filtering
5. All 6 child components - Prop handling and rendering

### Recommended Status

**⚠️ Changes Required - Immediate Action Needed**

This story demonstrates excellent code architecture and implementation, but **cannot be marked as Done** until:

1. ✅ **Critical Bug Fixed** - Completed by QA
2. ❌ **Test Infrastructure Setup** - Required before Done
3. ❌ **Automated Tests Implemented** - Required before Done
4. ❌ **Manual Verification Completed** - Required before Done

**Next Steps:**
1. Developer sets up Vitest + React Testing Library
2. Developer implements unit tests for components and hooks
3. Developer creates Firebase test users
4. Developer performs manual UI testing per story checklist
5. Developer updates story status to "Done" once all testing complete

**Timeline Recommendation:** Do not deploy to production until automated tests are in place and manual verification is complete.

### Additional Notes

**Positive Observations:**
- Developer's honest DoD assessment noting lack of testing is appreciated
- Component structure is clean and follows React best practices
- Real-time listeners properly implemented with cleanup
- Responsive design verified via automated screenshots
- All 10 tasks completed as specified

**Learning Opportunities:**
- Always run code locally during development to catch runtime bugs
- Implement tests incrementally alongside feature development
- Use React DevTools to inspect component renders and state updates
- Consider pair programming or code review before QA for complex logic

**For Future Stories:**
- Set up test infrastructure as Story 0 before feature work
- Include "tests passing" as a task completion criteria
- Allocate time for manual testing in story estimates
